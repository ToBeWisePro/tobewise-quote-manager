# SuperSubjects – Developer Guide

> _Audience: front-end & back-end engineers working on ToBeWise Quote Manager_
>
> _Last updated: {{date}}

---

## 1. What are SuperSubjects?
A **SuperSubject** is a curated grouping of related quote **subjects** and **authors** that surfaces higher-level themes (e.g. _“Innovation & Visionaries”_).

They power:
* Sidebar navigation under **“Super-Subjects”**.
* The Author/Subject explorer pages for thematic browsing.
* Future recommendation & marketing modules.

---

## 2. Firestore schema
| Field            | Type            | Required | Notes |
|------------------|-----------------|----------|-------|
| `name`           | `string`        | ✔︎        | Display title, **document ID** as slugified variant. Must be unique. |
| `subjects`       | `string[]`      | ✔︎        | Lower-cased subject slugs (e.g. `"innovation"`). |
| `authors`        | `string[]`      | ✔︎        | Exact author names as stored in `quote_authors`. |
| `image`          | `string` (URL)  | ✖︎        | Firebase Storage download URL – 384×512 portrait JPG. |
| `updatedAt`      | `string` (ISO)  | ✖︎        | Set by the admin UI on every edit. |

**Collection path:**
```text
quote_supersubjects/{supersubjectId}
```
`supersubjectId` is usually `name.toLowerCase().replace(/[^a-z0-9]/g, '_')` but can be any unique key.

### Example document (Innovation & Visionaries)
```jsonc
{
  "name": "Innovation & Visionaries",
  "subjects": ["innovation", "creativity", "future", "technology", "change"],
  "authors": [
    "Steve Jobs",
    "Elon Musk",
    "Marc Andreessen",
    "Peter Thiel",
    "Clayton Christensen"
  ],
  "image": "https://firebasestorage.googleapis.com/v0/b/<project>.appspot.com/o/supersubject_images/innovation___visionaries.jpg?alt=media&token=...",
  "updatedAt": "2025-07-28T18:13:22.491Z"
}
```

---

## 3. Querying from code

### 3.1 Client-side (Web/React)
```ts
import { collection, getDocs, query, where } from 'firebase/firestore';
import { db } from '../lib/firebase';

async function fetchSuperSubjects() {
  const snap = await getDocs(collection(db, 'quote_supersubjects'));
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}
```
_Filtering example:_
```ts
const q = query(
  collection(db, 'quote_supersubjects'),
  where('subjects', 'array-contains', 'innovation')
);
```

### 3.2 Server-side / Admin SDK
```ts
// in Cloud Functions or Node script
const admin = require('firebase-admin');
admin.initializeApp();

const col = admin.firestore().collection('quote_supersubjects');
const doc = await col.doc('innovation___visionaries').get();
console.log(doc.data());
```

---

## 4. Images in Firebase Storage
* **Bucket path:** `supersubject_images/`
* **Filename:** slugified name + original extension, e.g. `innovation___visionaries.jpg`
* **Dimensions:** 384×512 px, JPEG ~90 % quality (generated by `squareImageBlob` helper).

### Upload (already handled in admin UI)
```ts
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import { storage } from '../lib/firebase';

const blob = await fetch(localObjUrl).then(r => r.blob());
const clean = slugify(name);
const imgRef = ref(storage, `supersubject_images/${clean}.jpg`);
await uploadBytes(imgRef, blob, { contentType: blob.type });
const url = await getDownloadURL(imgRef);
```

### Download
```ts
import { ref, getDownloadURL } from 'firebase/storage';
const url = await getDownloadURL(ref(storage, 'supersubject_images/innovation___visionaries.jpg'));
```

---

## 5. Security rules
```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /supersubject_images/{allPaths=**} {
      allow read: if true;            // public read
      allow write: if request.auth != null &&
                    request.auth.token.admin == true; // only project admins
    }
  }
}
```
_Update as needed for your auth model._

---

## 6. Admin UI specifics
* **Drag-and-drop or File Picker** → uploads new portrait.
* **Row highlighting** shows currently edited super-subject.
* **Save** →
  1. Optionally uploads image ‑> Storage
  2. Writes/merges Firestore document
* **New entries** appear at top while editing; existing rows edit in-place.

---

## 7. Troubleshooting
| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| _storage/unauthorized_ | Firebase Storage rules deny write | Ensure logged-in account has write access or relax rules. |
| Hydration error “text node cannot be child of `<tbody>`” | Stray text in JSX | Ensure mapping returns only `<tr>` elements (fixed in v2025-07-28). |
| Duplicate-key warning | Duplicate `name` fields | Keep `name` unique; dedup list queries with `Set`. |

---

Happy coding! 